<!doctype html>
<html>
  <head>
    <base target="_top" />
    <style>
      /* Reset and base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen",
          "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue",
          sans-serif;
        padding: 8px;
        background-color: #ffffff;
        color: #0f172a;
      }

      /* Container */
      .container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* Accordion styles */
      .accordion {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .accordion-header {
        background-color: #f8fafc;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }

      .accordion-header:hover {
        background-color: #f1f5f9;
      }

      .accordion-title {
        font-size: 14px;
        font-weight: 500;
        color: #0f172a;
      }

      .accordion-icon {
        font-size: 12px;
        color: #64748b;
        transition: transform 0.2s ease;
        display: inline-block;
      }

      .accordion-content {
        padding: 12px;
        display: none;
      }

      .accordion.active .accordion-content {
        display: block;
      }

      .accordion.active .accordion-icon {
        transform: rotate(90deg);
      }

      /* shadcn-style textarea */
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .label {
        font-size: 14px;
        font-weight: 500;
        color: #0f172a;
      }

      .textarea {
        width: 100%;
        min-height: 100px;
        padding: 6px 10px;
        font-size: 14px;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        line-height: 1.4;
        color: #0f172a;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
        outline: none;
        resize: vertical;
      }

      .textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .textarea:disabled {
        background-color: #f8fafc;
        color: #94a3b8;
        cursor: not-allowed;
      }

      /* Current replacement display */
      .replacement-card {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
        display: none;
      }

      .replacement-card.active {
        display: block;
      }

      .replacement-header {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .replacement-counter {
        background-color: #e2e8f0;
        color: #475569;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
      }

      .replacement-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .replacement-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .replacement-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
      }

      .replacement-text {
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        font-size: 14px;
        background-color: #ffffff;
        padding: 6px;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
        word-break: break-all;
      }

      .replacement-text.before {
        background-color: #fee2e2;
        border-color: #fecaca;
      }

      .replacement-text.after {
        background-color: #dcfce7;
        border-color: #bbf7d0;
      }

      /* Toggle switch */
      .toggle-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 6px;
      }

      .toggle {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }

      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #e2e8f0;
        transition: 0.2s ease;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.2s ease;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #3b82f6;
      }

      input:checked + .slider:before {
        transform: translateX(20px);
      }

      .toggle-label {
        font-size: 14px;
        color: #0f172a;
        user-select: none;
      }

      /* Control buttons */
      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        font-size: 14px;
        font-weight: 500;
        height: 32px;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
        min-width: 80px;
      }

      .button.primary {
        background-color: #0f172a;
        color: #ffffff;
      }

      .button.primary:hover {
        background-color: #1e293b;
      }

      .button.secondary {
        background-color: #ffffff;
        color: #0f172a;
        border: 1px solid #e2e8f0;
      }

      .button.secondary:hover {
        background-color: #f8fafc;
      }

      .button.success {
        background-color: #16a34a;
        color: #ffffff;
      }

      .button.success:hover {
        background-color: #15803d;
      }

      .button.danger {
        background-color: #dc2626;
        color: #ffffff;
      }

      .button.danger:hover {
        background-color: #b91c1c;
      }

      .button:active {
        transform: scale(0.98);
      }

      .button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Message styles */
      .message {
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
      }

      .message.success {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .message.error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .message.info {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }

      /* Loading spinner */
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #e2e8f0;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Rule list */
      .rule-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background-color: #f8fafc;
      }

      .rule-item {
        padding: 6px 10px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 13px;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .rule-item:last-child {
        border-bottom: none;
      }

      .rule-item:hover {
        background-color: #f1f5f9;
      }

      .rule-actions {
        display: flex;
        gap: 4px;
      }

      .icon-button {
        width: 24px;
        height: 24px;
        padding: 4px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }

      .icon-button:hover {
        background-color: #e2e8f0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Top Buttons -->
      <div class="controls" style="margin-bottom: 8px">
        <button
          id="yankAllButton"
          class="button primary"
          onclick="copyAllDocumentText()"
        >
          Yank All
        </button>
        <button
          id="instructionButton"
          class="button secondary"
          onclick="showInstructions()"
        >
          Instruction
        </button>
      </div>

      <div class="accordion active" id="rulesAccordion">
        <div class="accordion-header" onclick="toggleAccordion()">
          <span class="accordion-title"
            >Search & Replace Rules (TOML format)</span
          >
          <span class="accordion-icon">▶</span>
        </div>
        <div class="accordion-content">
          <div class="input-group">
            <textarea
              id="rulesInput"
              class="textarea"
              placeholder='"search text" = "replace text"&#10;"another search" = "another replace"'
              rows="5"
            ></textarea>
          </div>
          <div class="controls" style="margin-top: 8px">
            <button
              id="parseButton"
              class="button primary"
              onclick="parseRules()"
            >
              Parse Rules
            </button>
            <button
              id="clearButton"
              class="button secondary"
              onclick="clearRules()"
            >
              Clear
            </button>
          </div>
        </div>
      </div>

      <div id="ruleListContainer" class="accordion" style="display: none">
        <div class="accordion-header" onclick="toggleRulesAccordion()">
          <span class="accordion-title">Parsed Rules</span>
          <span class="accordion-icon" id="rulesAccordionIcon">▶</span>
        </div>
        <div class="accordion-content">
          <div id="ruleList" class="rule-list"></div>
        </div>
      </div>

      <div id="editRuleContainer" class="accordion" style="display: none">
        <div class="accordion-header" onclick="toggleEditAccordion()">
          <span class="accordion-title">Edit Rule</span>
          <span class="accordion-icon" id="editAccordionIcon">▶</span>
        </div>
        <div class="accordion-content">
          <div class="input-group">
            <label class="label">Search text:</label>
            <textarea
              id="editSearchInput"
              class="textarea"
              placeholder="Enter search text"
              rows="2"
            ></textarea>
          </div>
          <div class="input-group" style="margin-top: 8px">
            <label class="label">Replace text:</label>
            <textarea
              id="editReplaceInput"
              class="textarea"
              placeholder="Enter replace text"
              rows="2"
            ></textarea>
          </div>
          <div class="controls" style="margin-top: 8px">
            <button
              id="saveEditButton"
              class="button success"
              onclick="saveEditRule()"
            >
              Save
            </button>
            <button
              id="cancelEditButton"
              class="button secondary"
              onclick="cancelEditRule()"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div id="replacementCard" class="replacement-card">
        <div class="replacement-header">
          <span>Current Replacement</span>
          <span id="replacementCounter" class="replacement-counter">1 / 1</span>
        </div>
        <div class="replacement-content">
          <div class="replacement-item">
            <span class="replacement-label">Search for:</span>
            <div id="beforeText" class="replacement-text before"></div>
          </div>
          <div class="replacement-item">
            <span class="replacement-label">Replace with:</span>
            <div id="afterText" class="replacement-text after"></div>
          </div>
        </div>
      </div>

      <div id="navigationControls" style="display: none">
        <div class="controls">
          <button
            id="prevButton"
            class="button secondary"
            onclick="previousRule()"
          >
            Previous
          </button>
          <button id="nextButton" class="button secondary" onclick="nextRule()">
            Next
          </button>
        </div>
        <div class="controls" style="margin-top: 6px">
          <button
            id="replaceButton"
            class="button success"
            onclick="replaceCurrentAll()"
          >
            Replace
          </button>
          <button
            id="skipButton"
            class="button secondary"
            onclick="skipCurrent()"
          >
            Skip
          </button>
        </div>
        <div class="toggle-container">
          <span class="toggle-label">Highlight:</span>
          <label class="toggle">
            <input
              type="checkbox"
              id="highlightToggle"
              onchange="toggleHighlight()"
            />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div id="messageContainer"></div>
    </div>

    <script>
      let rules = [];
      let currentIndex = 0;
      let processedRules = new Set();
      let editingIndex = -1;

      function toggleAccordion() {
        const accordion = document.getElementById("rulesAccordion");
        accordion.classList.toggle("active");
      }

      function toggleRulesAccordion() {
        const container = document.getElementById("ruleListContainer");
        container.classList.toggle("active");
      }

      function toggleEditAccordion() {
        const container = document.getElementById("editRuleContainer");
        container.classList.toggle("active");
      }

      function toggleHighlight() {
        const toggle = document.getElementById("highlightToggle");
        const isChecked = toggle.checked;

        if (rules.length === 0 || currentIndex >= rules.length) {
          showMessage("No current rule to highlight", "error");
          toggle.checked = false;
          return;
        }

        const rule = rules[currentIndex];
        const button = toggle;

        // Disable toggle during operation
        button.disabled = true;

        if (isChecked) {
          // Highlight the current rule's search text
          google.script.run
            .withSuccessHandler(function (response) {
              if (response.success) {
                showMessage(`Highlighted: ${response.message}`, "success");
              } else {
                showMessage(response.message, "error");
                toggle.checked = false;
              }
              button.disabled = false;
            })
            .withFailureHandler(function (error) {
              showMessage("Failed to highlight: " + error, "error");
              toggle.checked = false;
              button.disabled = false;
            })
            .highlightText(rule.before);
        } else {
          // Remove highlights for the current rule's search text
          google.script.run
            .withSuccessHandler(function (response) {
              if (response.success) {
                showMessage(`Unhighlighted: ${response.message}`, "success");
              } else {
                showMessage(response.message, "error");
              }
              button.disabled = false;
            })
            .withFailureHandler(function (error) {
              showMessage("Failed to remove highlight: " + error, "error");
              button.disabled = false;
            })
            .removeHighlightForText(rule.before);
        }
      }

      function parseRules() {
        const input = document.getElementById("rulesInput");
        const text = input.value.trim();

        if (!text) {
          showMessage("Please enter some rules", "error");
          return;
        }

        rules = [];
        const lines = text.split("\n");

        for (const line of lines) {
          const trimmed = line.trim();
          if (!trimmed) continue;

          // Skip lines without "=" (comments, sections, etc.)
          if (!trimmed.includes("=")) continue;

          // Parse TOML-style syntax: "before" = "after"
          const match = trimmed.match(/^"([^"]+)"\s*=\s*"([^"]+)"$/);
          if (match) {
            rules.push({
              before: match[1],
              after: match[2],
              id: `rule_${rules.length}`,
            });
          }
          // Silently skip invalid lines instead of showing error
        }

        if (rules.length === 0) {
          showMessage("No valid rules found", "error");
          return;
        }

        currentIndex = 0;
        processedRules.clear();
        displayRuleList();
        displayCurrentRule();
        showMessage(
          `Parsed ${rules.length} rule${rules.length > 1 ? "s" : ""}`,
          "success",
        );
      }

      function displayRuleList() {
        const container = document.getElementById("ruleListContainer");
        const list = document.getElementById("ruleList");

        list.innerHTML = rules
          .map(
            (rule, index) => `
          <div class="rule-item" data-index="${index}">
            <span>"${rule.before}" = "${rule.after}"</span>
            <div class="rule-actions">
              <button class="icon-button" onclick="editRule(${index})" title="Edit">
                ✏️
              </button>
              <button class="icon-button" onclick="deleteRule(${index})" title="Delete">
                🗑️
              </button>
            </div>
          </div>
        `,
          )
          .join("");

        container.style.display = "block";
        container.classList.add("active");
        document.getElementById("navigationControls").style.display =
          rules.length > 0 ? "block" : "none";
      }

      function displayCurrentRule() {
        if (rules.length === 0) {
          document.getElementById("replacementCard").classList.remove("active");
          return;
        }

        const rule = rules[currentIndex];
        document.getElementById("beforeText").textContent = rule.before;
        document.getElementById("afterText").textContent = rule.after;
        document.getElementById("replacementCounter").textContent =
          `${currentIndex + 1} / ${rules.length}`;
        document.getElementById("replacementCard").classList.add("active");

        // Reset highlight toggle when switching rules
        document.getElementById("highlightToggle").checked = false;

        updateNavigationButtons();
      }

      function updateNavigationButtons() {
        document.getElementById("prevButton").disabled = currentIndex === 0;
        document.getElementById("nextButton").disabled =
          currentIndex === rules.length - 1;
        document.getElementById("replaceButton").disabled =
          processedRules.has(currentIndex);

        if (processedRules.has(currentIndex)) {
          document.getElementById("replaceButton").textContent = "Replaced";
        } else {
          document.getElementById("replaceButton").textContent = "Replace";
        }
      }

      function previousRule() {
        if (currentIndex > 0) {
          currentIndex--;
          displayCurrentRule();
        }
      }

      function nextRule() {
        if (currentIndex < rules.length - 1) {
          currentIndex++;
          displayCurrentRule();
        }
      }

      function skipCurrent() {
        processedRules.add(currentIndex);
        if (currentIndex < rules.length - 1) {
          nextRule();
        } else {
          showMessage("All rules processed!", "info");
        }
      }

      function replaceCurrentAll() {
        const rule = rules[currentIndex];
        const button = document.getElementById("replaceButton");
        const highlightToggle = document.getElementById("highlightToggle");

        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span>Replacing...';

        // First, remove highlights if they exist
        if (highlightToggle.checked) {
          google.script.run
            .withSuccessHandler(function (removeResponse) {
              // After removing highlights, proceed with replacement
              performReplacement();
            })
            .withFailureHandler(function (error) {
              // If highlight removal fails, still try to replace
              console.warn("Failed to remove highlights:", error);
              performReplacement();
            })
            .removeHighlightForText(rule.before);

          // Reset highlight toggle
          highlightToggle.checked = false;
        } else {
          // No highlights to remove, proceed directly with replacement
          performReplacement();
        }

        function performReplacement() {
          google.script.run
            .withSuccessHandler(function (response) {
              if (response.success) {
                processedRules.add(currentIndex);
                showMessage(
                  `Replaced ${response.count} occurrence(s)`,
                  "success",
                );

                if (currentIndex < rules.length - 1) {
                  setTimeout(() => nextRule(), 1000);
                } else {
                  showMessage("All rules processed!", "info");
                }
              } else {
                showMessage(response.message, "error");
              }
              updateNavigationButtons();
            })
            .withFailureHandler(function (error) {
              showMessage("Failed to replace: " + error, "error");
              button.disabled = false;
              button.textContent = "Replace";
            })
            .searchAndReplace(rule.before, rule.after);
        }
      }

      function editRule(index) {
        const rule = rules[index];
        editingIndex = index;

        // Populate the edit form
        document.getElementById("editSearchInput").value = rule.before;
        document.getElementById("editReplaceInput").value = rule.after;

        // Show and expand the edit accordion
        const editContainer = document.getElementById("editRuleContainer");
        editContainer.style.display = "block";
        editContainer.classList.add("active");

        // Focus on the search input
        setTimeout(() => {
          document.getElementById("editSearchInput").focus();
        }, 100);
      }

      function saveEditRule() {
        if (editingIndex === -1) return;

        const newBefore = document
          .getElementById("editSearchInput")
          .value.trim();
        const newAfter = document
          .getElementById("editReplaceInput")
          .value.trim();

        if (!newBefore) {
          showMessage("Search text cannot be empty", "error");
          return;
        }

        const rule = rules[editingIndex];
        rules[editingIndex] = {
          before: newBefore,
          after: newAfter,
          id: rule.id,
        };

        displayRuleList();
        if (currentIndex === editingIndex) {
          displayCurrentRule();
        }

        cancelEditRule();
        showMessage("Rule updated successfully", "success");
      }

      function cancelEditRule() {
        editingIndex = -1;

        // Clear the edit form
        document.getElementById("editSearchInput").value = "";
        document.getElementById("editReplaceInput").value = "";

        // Hide the edit accordion
        const editContainer = document.getElementById("editRuleContainer");
        editContainer.classList.remove("active");
        editContainer.style.display = "none";
      }

      function deleteRule(index) {
        if (confirm("Delete this rule?")) {
          rules.splice(index, 1);
          if (currentIndex >= rules.length && currentIndex > 0) {
            currentIndex--;
          }
          displayRuleList();
          displayCurrentRule();
        }
      }

      function clearRules() {
        document.getElementById("rulesInput").value = "";
        rules = [];
        currentIndex = 0;
        processedRules.clear();
        document.getElementById("ruleListContainer").style.display = "none";
        document.getElementById("navigationControls").style.display = "none";
        document.getElementById("replacementCard").classList.remove("active");
        document.getElementById("messageContainer").innerHTML = "";
      }

      function showMessage(text, type) {
        const messageContainer = document.getElementById("messageContainer");
        messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;

        setTimeout(function () {
          messageContainer.innerHTML = "";
        }, 5000);
      }

      function copyAllDocumentText() {
        const button = document.getElementById("yankAllButton");

        // Disable button during operation
        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span>Copying...';

        google.script.run
          .withSuccessHandler(function (response) {
            if (response.success) {
              // Copy text to clipboard
              navigator.clipboard
                .writeText(response.content)
                .then(function () {
                  showMessage(
                    `Copied ${response.wordCount} words to clipboard`,
                    "success",
                  );
                })
                .catch(function (err) {
                  // Fallback: show text in a dialog for manual copy
                  showMessage(
                    `Failed to copy automatically. Text has ${response.wordCount} words.`,
                    "info",
                  );
                });
            } else {
              showMessage(response.message, "error");
            }
            button.disabled = false;
            button.textContent = "Yank All";
          })
          .withFailureHandler(function (error) {
            showMessage("Failed to get document text: " + error, "error");
            button.disabled = false;
            button.textContent = "Yank All";
          })
          .getDocumentContent();
      }

      function showInstructions() {
        google.script.run.showInstructionDialog();
      }

      // Allow Ctrl+Enter to parse rules
      document
        .getElementById("rulesInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
            parseRules();
          }
        });
    </script>
  </body>
</html>
